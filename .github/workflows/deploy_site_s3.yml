name: Deploy site to s3 for each PR
on:
  pull_request:

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout files
          uses: actions/checkout@v3
        - uses: hashicorp/setup-terraform@v2
        - name: Verify terraform files format
          run: terraform -chdir="terraform" fmt
          id: terraform_fmt
        - name: Init terraform
          run: terraform -chdir="terraform" init
          id: terraform_init
        - name: Check if terraform files are valids
          run: terraform -chdir="terraform" validate
          id: terraform_validate
        - name: Terraform plan
          run: terraform -chdir="terraform" plan -input=false
          id: terraform_plan
          continue-on-error: true
        - name: Update Pull Request
          uses: actions/github-script@v6
          env:
            PLAN: "terraform\n${{ steps.terraform_plan.outputs.* }}"
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              const output = `#### Terraform Format and Style ğŸ–Œ\`${{ steps.terraform_fmt.outcome }}\`
              #### Terraform Initialization âš™ï¸\`${{ steps.terraform_init.outcome }}\`
              #### Terraform Plan ğŸ“–\`${{ steps.terraform_plan.outcome }}\`
              #### Terraform Validation ğŸ¤–\`${{ steps.terraform_validate.outcome }}\`

              <details><summary>Show Plan</summary>

              \`\`\`\n
              ${process.env.PLAN}
              \`\`\`

              </details>

              *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              })
        # This step highlights whenever a plan fails because the "Terraform Plan" step continues on error.
        - name: Terraform Plan Status
          if: steps.terraform_plan.outcome == 'failure'
          run: exit 1
        - name: Terraform Apply
          run: terraform -chdir="terraform" apply -auto-approve -input=false